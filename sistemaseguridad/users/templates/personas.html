{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <h1 class="text-center my-4">Crear/Editar Persona</h1>

    <form id="personaForm" method="POST">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="id_nombre" class="form-label">{{ form.nombre.label }}</label>
                    {{ form.nombre }}
                </div>
                <div class="mb-3">
                    <label for="id_apellido" class="form-label">{{ form.apellido.label }}</label>
                    {{ form.apellido }}
                </div>
                <div class="mb-3">
                    <label for="id_fecha_nacimiento" class="form-label">{{ form.fecha_nacimiento.label }}</label>
                    {{ form.fecha_nacimiento }}
                </div>
                <div class="mb-3">
                    <label for="id_genero" class="form-label">{{ form.genero.label }}</label>
                    {{ form.genero }}
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="id_direccion" class="form-label">{{ form.direccion.label }}</label>
                    {{ form.direccion }}
                </div>
                <div class="mb-3">
                    <label for="id_telefono" class="form-label">{{ form.telefono.label }}</label>
                    {{ form.telefono }}
                </div>
                <div class="mb-3">
                    <label for="id_correo_electronico" class="form-label">{{ form.correo_electronico.label }}</label>
                    {{ form.correo_electronico }}
                </div>
                <div class="mb-3">
                    <label for="id_estado_civil" class="form-label">{{ form.estado_civil.label }}</label>
                    {{ form.estado_civil }}
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary" id="submitBtn">Enviar
            <i class="bi bi-send"></i>
        </button>
    </form>

    <h5 class="mt-4">Listado de Personas</h5>
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Apellido</th>
                <th>Fecha Nacimiento</th>
                <th>Género</th>
                <th>Dirección</th>
                <th>Teléfono</th>
                <th>Correo Electrónico</th>
                <th>Estado Civil</th>
                <th>Usuario Creación</th>
                <th>Usuario Modificación</th>
                <th>Opciones</th>
            </tr>
        </thead>
        <tbody>
            {% for persona in listado_personas %}
            <tr>
                <td>{{ persona.nombre }}</td>
                <td>{{ persona.apellido }}</td>
                <td>{{ persona.fecha_nacimiento }}</td>
                <td>{{ persona.genero }}</td>
                <td>{{ persona.direccion }}</td>
                <td>{{ persona.telefono }}</td>
                <td>{{ persona.correo_electronico }}</td>
                <td>{{ persona.estado_civil }}</td>
                <td>{{ persona.usuario_creacion }}</td>
                <td>{{ persona.usuario_modificacion }}</td>
                <td>
                    <button class="btn btn-warning btn-sm" data-id="{{ persona.id }}" data-nombre="{{ persona.nombre }}"
                        data-apellido="{{ persona.apellido }}" data-fecha_nacimiento="{{ persona.fecha_nacimiento }}"
                        data-genero="{{ persona.genero }}" data-direccion="{{ persona.direccion }}"
                        data-telefono="{{ persona.telefono }}"
                        data-correo_electronico="{{ persona.correo_electronico }}"
                        data-estado_civil="{{ persona.estado_civil }}" title="Editar" onclick="editarPersona(
        '{{ persona.id }}', 
        '{{ persona.nombre }}',
        '{{ persona.apellido }}',
        '{{ persona.fecha_nacimiento }}',
        '{{ persona.genero }}',
        '{{ persona.direccion }}',
        '{{ persona.telefono }}',
        '{{ persona.correo_electronico }}',
        '{{ persona.estado_civil }}');">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" data-id="{{ persona.id }}" title="Eliminar"
                        onclick="eliminarPersona('{{ persona.id }}');">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td class="text-center" colspan="12">No hay personas creadas</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <a href="{% url 'cuenta_corriente' %}" class="btn btn-danger mb-3">
        <i class="bi bi-arrow-left"></i> Volver
    </a>
</div>

<!-- Modal para editar persona -->
<div class="modal fade" id="editarPersonaModal" tabindex="-1" aria-labelledby="editarPersonaModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editarPersonaModalLabel">Editar Persona</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editarPersonaForm">
                    <input type="hidden" id="edit-persona-id" name="id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-nombre-persona" class="form-label">Nombre:</label>
                                <input type="text" class="form-control" id="edit-nombre-persona" name="nombre" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-apellido-persona" class="form-label">Apellido:</label>
                                <input type="text" class="form-control" id="edit-apellido-persona" name="apellido"
                                    required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-fecha-nacimiento" class="form-label">Fecha de Nacimiento:</label>
                                <input type="date" class="form-control" id="edit-fecha-nacimiento"
                                    name="fecha_nacimiento">
                            </div>
                            <div class="mb-3">
                                <label for="edit-genero" class="form-label">Género:</label>
                                <select class="form-control" id="edit-genero" name="genero">
                                    {% for genero in generos %}
                                    <option value="{{ genero.id }}">{{ genero.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="edit-direccion" class="form-label">Dirección:</label>
                                <input type="text" class="form-control" id="edit-direccion" name="direccion">
                            </div>
                            <div class="mb-3">
                                <label for="edit-telefono" class="form-label">Teléfono:</label>
                                <input type="text" class="form-control" id="edit-telefono" name="telefono">
                            </div>
                            <div class="mb-3">
                                <label for="edit-correo-electronico" class="form-label">Correo Electrónico:</label>
                                <input type="email" class="form-control" id="edit-correo-electronico"
                                    name="correo_electronico">
                            </div>
                            <div class="mb-3">
                                <label for="edit-estado-civil" class="form-label">Estado Civil:</label>
                                <select class="form-control" id="edit-estado-civil" name="estado_civil">
                                    {% for estado in estados_civiles %}
                                    <option value="{{ estado.id }}">{{ estado.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar
                    <i class="bi bi-x-circle"></i>
                </button>
                <button type="button" class="btn btn-primary btn-update" id="actualizarPersonaBtn">Actualizar
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Funciones JavaScript para gestionar la creación, edición y eliminación de personas
    document.getElementById('personaForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const formData = new FormData(this);
        const id = document.getElementById('id_persona') ? document.getElementById('id_persona').value : null;

        if (id) {
            Swal.fire({
                title: '¿Está seguro que desea actualizar esta persona?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Sí, actualizar',
                cancelButtonText: 'No',
            }).then((result) => {
                if (result.isConfirmed) {
                    enviarDatosPersona(formData, id, 'PUT');
                }
            });
        } else {
            enviarDatosPersona(formData, null, 'POST');
        }
    });

    function enviarDatosPersona(formData, id = null, method = 'POST') {
        const url = id ? `/users/personas/editar/${id}/` : '{% url "personas" %}';
        fetch(url, {
            method: method,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: formData,
        })
            .then(response => response.json())
            .then(data => {
                if (data.Persona) {
                    Swal.fire('¡Éxito!', 'Persona creada con éxito.', 'success');
                    document.getElementById('personaForm').reset();
                    actualizarTablaPersonas();
                } else {
                    Swal.fire('¡Error!', 'Hubo un problema al crear o actualizar la persona.', 'error');
                }
            })
            .catch(error => {
                Swal.fire('¡Error!', 'Hubo un problema en la solicitud.', 'error');
            });
    }

    function actualizarTablaPersonas() {
        fetch('/users/personas/')
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('table tbody');
                tbody.innerHTML = '';

                data.forEach(persona => {
                    const row = `<tr>
                    <td>${persona.nombre}</td>
                    <td>${persona.apellido}</td>
                    <td>${persona.fecha_nacimiento}</td>
                    <td>${persona.genero}</td>
                    <td>${persona.direccion}</td>
                    <td>${persona.telefono}</td>
                    <td>${persona.correo_electronico}</td>
                    <td>${persona.estado_civil}</td>
                    <td>${persona.usuario_creacion}</td>
                    <td>${persona.usuario_modificacion}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" 
                        data-id="${persona.id}" 
                        data-nombre="${persona.nombre}" 
                        data-nombre="${persona.apellido}" 
                        data-nombre="${persona.fecha_nacimiento}" 
                        data-nombre="${persona.genero}" 
                        data-nombre="${persona.direccion}" 
                        data-nombre="${persona.telefono}" 
                        data-nombre="${persona.correo_electronico}" 
                        data-nombre="${persona.estado_civil}" 
                        title="Editar"
                            onclick="editarPersona(
                            '${persona.id}', 
                            '${persona.nombre}',
                            '${persona.apellido}',
                            '${persona.fecha_nacimiento}',
                            '${persona.genero}',
                            '${persona.direccion}',
                            '${persona.telefono}',
                            '${persona.correo_electronico}',
                            '${persona.estado_civil}'">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" data-id="${persona.id}" title="Eliminar"
                            onclick="eliminarPersona('${persona.id}');">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
                    tbody.innerHTML += row;
                });
            });
    }

    function editarPersona(id, nombre, apellido, fecha_nacimiento, genero, direccion, telefono, correo_electronico, estado_civil) {
        // Rellenar los datos en el modal
        document.getElementById('edit-persona-id').value = id;
        document.getElementById('edit-nombre-persona').value = nombre;
        document.getElementById('edit-apellido-persona').value = apellido;
        document.getElementById('edit-genero').value = genero;
        document.getElementById('edit-fecha-nacimiento').value = fecha_nacimiento;
        document.getElementById('edit-telefono').value = telefono;
        document.getElementById('edit-direccion').value = direccion;
        document.getElementById('edit-correo-electronico').value = correo_electronico;
        document.getElementById('edit-estado-civil').value = estado_civil;


        // Mostrar el modal
        var editarPersonaModal = new bootstrap.Modal(document.getElementById('editarPersonaModal'));
        editarPersonaModal.show();
        // Cargar los demás datos de la persona a través de una solicitud AJAX

    }

    document.getElementById('actualizarPersonaBtn').addEventListener('click', function () {
        const id = document.getElementById('edit-persona-id').value;

        // Rellenar datos de los campos antes de enviar el formulario
        const formData = new FormData(document.getElementById('editarPersonaForm'));
        actualizarPersona(formData, id);
    });

    function actualizarPersona(formData, id) {
        fetch(`/users/personas/editar/${id}/`, {
            method: 'PUT',  // Usa PUT si es actualización
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Éxito', 'Persona actualizada con éxito.', 'success').then(() => {
                        const row = document.querySelector(`button[data-id="${id}"]`).closest('tr');
                        row.querySelector('td:nth-child(1)').textContent = formData.get('nombre');
                        row.querySelector('td:nth-child(2)').textContent = formData.get('apellido');
                        row.querySelector('td:nth-child(3)').textContent = formData.get('fecha_nacimiento');
                        row.querySelector('td:nth-child(4)').textContent = data.genero_nombre;
                        row.querySelector('td:nth-child(5)').textContent = formData.get('direccion');
                        row.querySelector('td:nth-child(6)').textContent = formData.get('telefono');
                        row.querySelector('td:nth-child(7)').textContent = formData.get('correo_electronico');
                        row.querySelector('td:nth-child(8)').textContent = data.estado_civil_nombre;
                        row.querySelector('td:nth-child(10)').textContent = data.usuario_modificacion;

                        // Oculta el modal después de la actualización
                        var editarPersonaModal = bootstrap.Modal.getInstance(document.getElementById('editarPersonaModal'));
                        editarPersonaModal.hide();
                    });
                } else {
                    Swal.fire('Error', 'Hubo un problema al actualizar la persona.', 'error');
                }
            })
            .catch(error => {
                Swal.fire('Error', 'Hubo un problema en la solicitud.', 'error');
            });
    }

    function actualizarPersona(formData) {
        const id = document.getElementById('edit-persona-id').value;

        fetch(`/users/personas/editar/${id}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('Éxito', 'Persona actualizada con éxito.', 'success').then(() => {

                        // Actualizar la fila correspondiente en la tabla
                        const button = document.querySelector(`button[data-id="${id}"]`);
                        if (button) {
                            // Actualizar los datos en la tabla
                            button.setAttribute('data-nombre', formData.get('nombre'));
                            const row = button.closest('tr');
                            row.querySelector('td:nth-child(1)').textContent = formData.get('nombre');
                            row.querySelector('td:nth-child(2)').textContent = formData.get('apellido');
                            row.querySelector('td:nth-child(3)').textContent = formData.get('fecha_nacimiento');
                            row.querySelector('td:nth-child(4)').textContent = data.genero_nombre;
                            row.querySelector('td:nth-child(5)').textContent = formData.get('direccion');
                            row.querySelector('td:nth-child(6)').textContent = formData.get('telefono');
                            row.querySelector('td:nth-child(7)').textContent = formData.get('correo_electronico');
                            row.querySelector('td:nth-child(8)').textContent = data.estado_civil_nombre;
                            row.querySelector('td:nth-child(9)').textContent = data.tipo_documento_nombre;
                        }
                        // Cerrar el modal
                        var editarPersonaModal = bootstrap.Modal.getInstance(document.getElementById('editarPersonaModal'));
                        editarPersonaModal.hide();
                        location.reload();
                    });
                } else {
                    Swal.fire('Error', 'Hubo un problema al actualizar la persona.', 'error');
                }
            })
            .catch(error => {
                Swal.fire('Error', 'Hubo un problema en la solicitud.', 'error');
            });
    }


    function eliminarPersona(id) {
        Swal.fire({
            title: '¿Está seguro?',
            text: "Una vez eliminada, no podrás recuperar esta persona.",
            icon: 'warning',
            showCancelButton: true,
            
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'No, cancelar',
            preConfirm: () => {
                return fetch(`/users/persona/eliminar/${id}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('No se pudo eliminar la persona');
                        }
                        return response.json();
                    })
                    .catch(error => {
                        Swal.showValidationMessage(`Error al eliminar: ${error}`);
                    });
            },
            allowOutsideClick: () => !Swal.isLoading()
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire('Eliminado!', 'La persona ha sido eliminada.', 'success');
                location.reload();
                actualizarTablaPersonas();
            }
        });
    }
</script>
{% endblock %}